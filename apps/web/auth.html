<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Zorem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; }
        
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-up { animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        
        .glass {
            background: rgba(20, 20, 22, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-background antialiased selection:bg-white/20 selection:text-white overflow-x-hidden text-neutral-300 min-h-screen flex items-center justify-center p-4">

    <!-- Background -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-1/2 -translate-x-1/2 w-[80%] h-[600px] bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] via-background to-background blur-[100px] opacity-50 from-violet-900/20"></div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 w-full max-w-md animate-fade-up">
        <!-- Logo -->
        <div class="flex items-center justify-center mb-8">
            <img src="assets/logo.png" alt="Zorem" class="w-12 h-12 object-contain">
        </div>

        <!-- Card -->
        <div class="glass rounded-2xl p-8">
            <h1 class="text-2xl font-medium text-white mb-2 text-center" id="pageTitle">Sign In</h1>
            <p class="text-sm text-neutral-400 text-center mb-8" id="pageSubtitle">Welcome back to Zorem</p>

            <!-- Tabs: Sign In / Sign Up -->
            <div class="flex gap-2 mb-6 bg-white/5 rounded-xl p-1">
                <button id="signInTab" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-white text-black">
                    Sign In
                </button>
                <button id="signUpTab" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:text-white">
                    Sign Up
                </button>
            </div>

            <!-- Google OAuth Button -->
            <button 
                id="googleSignInButton"
                class="w-full h-14 px-8 rounded-xl font-medium text-sm transition-all flex items-center justify-center gap-3 border border-white/10 hover:bg-white/5 mb-4"
            >
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>

            <div class="flex items-center gap-4 mb-6">
                <div class="flex-1 h-px bg-white/10"></div>
                <span class="text-xs text-neutral-500">or</span>
                <div class="flex-1 h-px bg-white/10"></div>
            </div>

            <!-- Sign In Form -->
            <form id="signInForm" class="space-y-6">
                <div>
                    <label class="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2 block">Email</label>
                    <input 
                        type="email" 
                        id="signInEmail"
                        placeholder="your@email.com"
                        class="w-full h-14 px-6 rounded-xl glass-input text-lg text-white placeholder:text-neutral-600 outline-none transition-all"
                        required
                        autofocus
                    >
                </div>

                <div>
                    <label class="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2 block">Password</label>
                    <input 
                        type="password" 
                        id="signInPassword"
                        placeholder="••••••••"
                        class="w-full h-14 px-6 rounded-xl glass-input text-lg text-white placeholder:text-neutral-600 outline-none transition-all"
                        required
                    >
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="rememberMe" class="w-4 h-4 rounded border-white/20 bg-white/5">
                        <span class="text-xs text-neutral-400">Remember me</span>
                    </label>
                    <a href="#" id="forgotPasswordLink" class="text-xs text-violet-400 hover:text-violet-300">Forgot password?</a>
                </div>

                <div id="errorMessage" class="hidden text-red-400 text-sm text-center"></div>
                <div id="successMessage" class="hidden text-green-400 text-sm text-center"></div>

                <button 
                    type="submit"
                    id="signInButton"
                    class="w-full h-14 px-8 rounded-xl font-medium text-sm transition-all overflow-hidden flex items-center justify-center gap-2 bg-white text-black hover:bg-neutral-200"
                >
                    <span>Sign In</span>
                </button>
            </form>

            <!-- Sign Up Form (hidden by default) -->
            <form id="signUpForm" class="space-y-6 hidden">
                <div>
                    <label class="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2 block">Email</label>
                    <input 
                        type="email" 
                        id="signUpEmail"
                        placeholder="your@email.com"
                        class="w-full h-14 px-6 rounded-xl glass-input text-lg text-white placeholder:text-neutral-600 outline-none transition-all"
                        required
                    >
                </div>

                <div>
                    <label class="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2 block">Password</label>
                    <input 
                        type="password" 
                        id="signUpPassword"
                        placeholder="At least 8 characters"
                        class="w-full h-14 px-6 rounded-xl glass-input text-lg text-white placeholder:text-neutral-600 outline-none transition-all"
                        required
                        minlength="8"
                    >
                </div>

                <div>
                    <label class="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2 block">Confirm Password</label>
                    <input 
                        type="password" 
                        id="signUpPasswordConfirm"
                        placeholder="Confirm your password"
                        class="w-full h-14 px-6 rounded-xl glass-input text-lg text-white placeholder:text-neutral-600 outline-none transition-all"
                        required
                    >
                </div>

                <label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" id="acceptTerms" class="w-4 h-4 rounded border-white/20 bg-white/5 mt-0.5" required>
                    <span class="text-xs text-neutral-400">I agree to the <a href="#" class="text-violet-400 hover:text-violet-300">Terms of Service</a> and <a href="#" class="text-violet-400 hover:text-violet-300">Privacy Policy</a></span>
                </label>

                <div id="signUpErrorMessage" class="hidden text-red-400 text-sm text-center"></div>
                <div id="signUpSuccessMessage" class="hidden text-green-400 text-sm text-center"></div>

                <button 
                    type="submit"
                    id="signUpButton"
                    class="w-full h-14 px-8 rounded-xl font-medium text-sm transition-all overflow-hidden flex items-center justify-center gap-2 bg-white text-black hover:bg-neutral-200"
                >
                    <span>Create Account</span>
                </button>
            </form>

            <!-- Magic Link Option -->
            <div class="mt-6 pt-6 border-t border-white/10">
                <button id="magicLinkToggle" class="w-full text-xs text-neutral-500 hover:text-white transition-colors">
                    Or use magic link instead
                </button>
            </div>

            <!-- Magic Link Form (hidden by default) -->
            <form id="magicLinkForm" class="space-y-6 hidden mt-6">
                <div>
                    <label class="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2 block">Email</label>
                    <input 
                        type="email" 
                        id="magicLinkEmail"
                        placeholder="your@email.com"
                        class="w-full h-14 px-6 rounded-xl glass-input text-lg text-white placeholder:text-neutral-600 outline-none transition-all"
                        required
                    >
                </div>

                <button 
                    type="submit"
                    id="magicLinkButton"
                    class="w-full h-14 px-8 rounded-xl font-medium text-sm transition-all overflow-hidden flex items-center justify-center gap-2 border border-white/10 hover:bg-white/5"
                >
                    <span>Send Magic Link</span>
                </button>
            </form>

            <div class="mt-6 text-center">
                <a href="index.html" class="text-xs text-neutral-500 hover:text-white transition-colors">Back to home</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { authAPI, utils } from './js/api.js';

        // Check if already authenticated
        if (utils.getAuthToken()) {
            window.location.href = 'create-room.html';
        }

        // Check if coming from magic link verification, email verification, or OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const verifyToken = urlParams.get('verify');
        const oauthToken = urlParams.get('oauth_token');
        const mode = urlParams.get('mode');

        if (verifyToken) {
            handleEmailVerification(verifyToken);
        } else if (token) {
            handleMagicLinkVerification(token);
        } else if (oauthToken) {
            handleOAuthCallback(oauthToken);
        }

        // Tab switching
        const signInTab = document.getElementById('signInTab');
        const signUpTab = document.getElementById('signUpTab');
        const signInForm = document.getElementById('signInForm');
        const signUpForm = document.getElementById('signUpForm');
        const pageTitle = document.getElementById('pageTitle');
        const pageSubtitle = document.getElementById('pageSubtitle');
        const magicLinkForm = document.getElementById('magicLinkForm');
        const magicLinkToggle = document.getElementById('magicLinkToggle');

        let isSignInMode = true;

        // Function to switch to Sign Up tab
        function switchToSignUp() {
            isSignInMode = false;
            signUpTab.classList.add('bg-white', 'text-black');
            signUpTab.classList.remove('text-neutral-400');
            signInTab.classList.remove('bg-white', 'text-black');
            signInTab.classList.add('text-neutral-400');
            signUpForm.classList.remove('hidden');
            signInForm.classList.add('hidden');
            magicLinkForm.classList.add('hidden');
            pageTitle.textContent = 'Sign Up';
            pageSubtitle.textContent = 'Create your Zorem account';
        }

        // If mode=signup, switch to sign up tab
        if (mode === 'signup') {
            switchToSignUp();
        }

        signInTab.addEventListener('click', () => {
            isSignInMode = true;
            signInTab.classList.add('bg-white', 'text-black');
            signInTab.classList.remove('text-neutral-400');
            signUpTab.classList.remove('bg-white', 'text-black');
            signUpTab.classList.add('text-neutral-400');
            signInForm.classList.remove('hidden');
            signUpForm.classList.add('hidden');
            magicLinkForm.classList.add('hidden');
            pageTitle.textContent = 'Sign In';
            pageSubtitle.textContent = 'Welcome back to Zorem';
        });

        signUpTab.addEventListener('click', () => {
            switchToSignUp();
        });

        magicLinkToggle.addEventListener('click', (e) => {
            e.preventDefault();
            magicLinkForm.classList.toggle('hidden');
            if (!magicLinkForm.classList.contains('hidden')) {
                signInForm.classList.add('hidden');
                signUpForm.classList.add('hidden');
            } else {
                if (isSignInMode) {
                    signInForm.classList.remove('hidden');
                } else {
                    signUpForm.classList.remove('hidden');
                }
            }
        });

        // Google OAuth
        document.getElementById('googleSignInButton').addEventListener('click', async () => {
            try {
                // Redirect to Google OAuth
                const result = await authAPI.getGoogleAuthUrl();
                if (result.auth_url) {
                    window.location.href = result.auth_url;
                }
            } catch (error) {
                showError('Failed to initiate Google sign in');
            }
        });

        // Sign In Form
        signInForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signInEmail').value.trim();
            const password = document.getElementById('signInPassword').value;
            const button = document.getElementById('signInButton');

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            try {
                button.disabled = true;
                button.innerHTML = '<span>Signing in...</span>';

                const result = await authAPI.signIn(email, password);

                if (result.requires_2fa) {
                    // Show 2FA input
                    show2FAInput(result.temp_token);
                } else {
                    utils.setAuthToken(result.token);
                    window.location.href = 'create-room.html';
                }
            } catch (error) {
                showError(error.message || 'Failed to sign in');
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>Sign In</span>';
            }
        });

        // Sign Up Form
        signUpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value;
            const passwordConfirm = document.getElementById('signUpPasswordConfirm').value;
            const button = document.getElementById('signUpButton');

            if (!email || !password || !passwordConfirm) {
                showSignUpError('Please fill all fields');
                return;
            }

            if (password !== passwordConfirm) {
                showSignUpError('Passwords do not match');
                return;
            }

            if (password.length < 8) {
                showSignUpError('Password must be at least 8 characters');
                return;
            }

            try {
                button.disabled = true;
                button.innerHTML = '<span>Creating account...</span>';

                const result = await authAPI.signUp(email, password);

                if (result.requires_verification) {
                    if (result.verification_link) {
                        // Development mode: show link
                        showSignUpSuccess(`Account created! Click <a href="${result.verification_link}" class="underline text-violet-400">here</a> to verify your email, or check your inbox.`);
                        
                        // Auto-verify if token is provided (development convenience)
                        if (result.token) {
                            setTimeout(() => {
                                utils.setAuthToken(result.token);
                                window.location.href = 'create-room.html';
                            }, 2000);
                        }
                    } else {
                        // Production mode
                        showSignUpSuccess('Account created! Please check your email to verify your account.');
                    }
                } else {
                    utils.setAuthToken(result.token);
                    window.location.href = 'create-room.html';
                }
            } catch (error) {
                showSignUpError(error.message || 'Failed to create account');
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>Create Account</span>';
            }
        });

        // Magic Link Form
        document.getElementById('magicLinkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('magicLinkEmail').value.trim();
            const button = document.getElementById('magicLinkButton');

            if (!email) {
                showError('Please enter your email');
                return;
            }

            try {
                button.disabled = true;
                button.innerHTML = '<span>Sending...</span>';

                const result = await authAPI.requestMagicLink(email);

                if (result.magic_link) {
                    showSuccess(`Magic link sent! Click <a href="${result.magic_link}" class="underline">here</a> to sign in.`);
                    if (result.token) {
                        setTimeout(() => {
                            handleMagicLinkVerification(result.token);
                        }, 1000);
                    }
                } else {
                    showSuccess('If an account exists with this email, a magic link has been sent.');
                }
            } catch (error) {
                showError(error.message || 'Failed to send magic link');
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>Send Magic Link</span>';
            }
        });

        async function handleMagicLinkVerification(token) {
            try {
                const result = await authAPI.verifyMagicLink(token);
                utils.setAuthToken(result.token);
                window.location.href = 'create-room.html';
            } catch (error) {
                showError('Invalid or expired magic link');
            }
        }

        async function handleEmailVerification(token) {
            try {
                const result = await authAPI.verifyEmail(token);
                utils.setAuthToken(result.token);
                showSuccess('Email verified successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'create-room.html';
                }, 1500);
            } catch (error) {
                showError('Invalid or expired verification link');
            }
        }

        async function handleOAuthCallback(token) {
            try {
                const result = await authAPI.verifyOAuthToken(token);
                utils.setAuthToken(result.token);
                window.location.href = 'create-room.html';
            } catch (error) {
                showError('Failed to complete Google sign in');
            }
        }

        function show2FAInput(tempToken) {
            const code = prompt('Enter the 6-digit code from your authenticator app:');
            if (code && code.length === 6) {
                authAPI.verify2FA(tempToken, code)
                    .then(result => {
                        utils.setAuthToken(result.token);
                        window.location.href = 'create-room.html';
                    })
                    .catch(error => {
                        showError('Invalid 2FA code');
                    });
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = message;
            errorMessage.classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.innerHTML = message;
            successMessage.classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSignUpError(message) {
            const errorMessage = document.getElementById('signUpErrorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            document.getElementById('signUpSuccessMessage').classList.add('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        function showSignUpSuccess(message) {
            const successMessage = document.getElementById('signUpSuccessMessage');
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            document.getElementById('signUpErrorMessage').classList.add('hidden');
        }
    </script>

</body>
</html>
